<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UCD成绩查询 - SE Knowledge Base</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .loading { display: none; }
    .spinner-border { width: 1.25rem; height: 1.25rem; }
    .table-container { max-height: 600px; overflow-y: auto; }
    .muted { color: #6c757d; }
    .nowrap { white-space: nowrap; }
    .section-divider { border-top: 2px solid #e9ecef; margin: 1.25rem 0; }

    /* 进度区 */
    #progressWrap { display:none; }
    #progressLogs { max-height:160px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    #progressLogs .time { color:#6c757d; }
  </style>
</head>
<body>
<div class="container mt-4">
  <div class="row"><div class="col-12">
    <h1 class="mb-4">UCD成绩查询</h1>

    <!-- 登录表单 -->
    <form id="loginForm" class="row g-3 mb-3" onsubmit="return false;">
      <div class="col-md-4">
        <label for="username" class="form-label">UCD 账号（Username）</label>
        <input type="text" class="form-control" id="username" autocomplete="username" required />
      </div>
      <div class="col-md-4">
        <label for="password" class="form-label">密码（Password）</label>
        <div class="input-group">
          <input type="password" class="form-control" id="password" autocomplete="current-password" required />
          <button class="btn btn-outline-secondary" type="button" id="togglePwd">显示</button>
        </div>
      </div>
      <div class="col-md-4 d-flex align-items-end gap-2">
        <button id="fetchBtn" class="btn btn-primary">获取成绩数据</button>
        <button id="testBtn" class="btn btn-outline-secondary">测试连接</button>
      </div>
    </form>

    <!-- 进度条 + 阶段提示 + 取消按钮 + 日志 -->
    <div id="progressWrap" class="mb-3">
      <div class="d-flex align-items-center justify-content-between mb-1">
        <div class="d-flex align-items-center gap-2">
          <div class="spinner-border text-primary" role="status"></div>
          <div>
            <div id="progressStage" class="fw-semibold">准备请求…</div>
            <div id="progressHint" class="text-muted small">请勿关闭此页面</div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div id="progressPct" class="text-muted">0%</div>
          <button id="cancelBtn" class="btn btn-sm btn-outline-danger">取消</button>
        </div>
      </div>
      <div class="progress" style="height:10px;">
        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%;" aria-valuemin="0" aria-valuemax="100"></div>
      </div>

      <div class="form-text mt-2">
        <a class="link-secondary small" data-bs-toggle="collapse" href="#progressLogsCollapse" role="button" aria-expanded="false" aria-controls="progressLogsCollapse">
          查看详情日志
        </a>
      </div>
      <div class="collapse mt-2" id="progressLogsCollapse">
        <div id="progressLogs" class="border rounded p-2 bg-light"></div>
      </div>
    </div>

    <!-- 加载状态（备用：错误时隐藏进度后展示） -->
    <div id="loading" class="loading text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">加载中...</span>
      </div>
      <p class="mt-2">正在获取成绩数据，请稍候...</p>
    </div>

    <!-- 错误/成功信息 -->
    <div id="error" class="alert alert-danger d-none" role="alert">
      <strong>错误：</strong><span id="errorMsg"></span>
    </div>
    <div id="success" class="alert alert-success d-none" role="alert">
      <strong>成功：</strong><span id="successMsg"></span>
    </div>

    <!-- 成绩汇总（总览） -->
    <div id="resultsContainer" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="mb-0">成绩汇总</h3>
        <small id="rowsCount" class="muted"></small>
      </div>
      <div class="table-container">
        <table class="table table-striped table-hover">
          <thead class="table-dark sticky-top">
          <tr>
            <th>学期</th>
            <th>阶段</th>
            <th>年份</th>
            <th>专业</th>
            <th>主修</th>
            <th class="nowrap">Stage GPA</th>
            <th class="nowrap">Semester GPA</th>
          </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </div>

    <hr class="section-divider d-none" id="divider"/>

    <!-- 课程明细（按学年分页） -->
    <div id="detailContainer" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="mb-0">课程明细（按学年分页）</h3>
        <div class="d-flex align-items-center gap-2">
          <button id="prevYearBtn" class="btn btn-sm btn-outline-secondary">上一学年</button>
          <select id="yearSelect" class="form-select form-select-sm" style="width:auto;"></select>
          <button id="nextYearBtn" class="btn btn-sm btn-outline-secondary">下一学年</button>
        </div>
      </div>

      <div class="card mb-2">
        <div class="card-body py-2">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <div><strong id="detailYearLabel">学年</strong></div>
            <div class="nowrap">Stage GPA：
              <span id="detailStageGpa" class="badge bg-primary"></span>
            </div>
            <div class="nowrap">Semester GPA：
              <span id="detailSemesterGpa" class="badge bg-secondary"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table class="table table-bordered table-hover">
          <thead class="table-light sticky-top">
          <tr>
            <th style="width:160px">学期</th>
            <th style="width:120px">课程代码</th>
            <th>课程名称</th>
            <th style="width:100px">阶段</th>
            <th style="width:80px" class="text-end">学分</th>
            <th style="width:80px" class="text-center">成绩</th>
          </tr>
          </thead>
          <tbody id="detailBody"></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between">
        <small id="detailCount" class="muted"></small>
        <div class="muted" id="pageIndicator"></div>
      </div>
    </div>

  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const fetchBtn = document.getElementById('fetchBtn');
  const testBtn = document.getElementById('testBtn');
  const togglePwd = document.getElementById('togglePwd');
  const usernameEl = document.getElementById('username');
  const passwordEl = document.getElementById('password');

  const progressWrap = document.getElementById('progressWrap');
  const progressBar = document.getElementById('progressBar');
  const progressPct = document.getElementById('progressPct');
  const progressStage = document.getElementById('progressStage');
  const progressHint = document.getElementById('progressHint');
  const progressLogs = document.getElementById('progressLogs');
  const cancelBtn = document.getElementById('cancelBtn');

  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  const success = document.getElementById('success');
  const errorMsg = document.getElementById('errorMsg');
  const successMsg = document.getElementById('successMsg');

  const resultsContainer = document.getElementById('resultsContainer');
  const resultsBody = document.getElementById('resultsBody');
  const rowsCount = document.getElementById('rowsCount');

  const divider = document.getElementById('divider');
  const detailContainer = document.getElementById('detailContainer');
  const prevYearBtn = document.getElementById('prevYearBtn');
  const nextYearBtn = document.getElementById('nextYearBtn');
  const yearSelect = document.getElementById('yearSelect');
  const detailYearLabel = document.getElementById('detailYearLabel');
  const detailStageGpa = document.getElementById('detailStageGpa');
  const detailSemesterGpa = document.getElementById('detailSemesterGpa');
  const detailBody = document.getElementById('detailBody');
  const detailCount = document.getElementById('detailCount');
  const pageIndicator = document.getElementById('pageIndicator');

  // ———————————— 进度条控制（前端拟真） ————————————
  let progressTimer = null;
  let progressVal = 0;
  let progressCeil = 95; // 响应未返回前最多到 95%
  let controller = null; // AbortController

  function logLine(msg) {
    const t = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.innerHTML = `<span class="time">[${t}]</span> ${msg}`;
    progressLogs.appendChild(div);
    progressLogs.scrollTop = progressLogs.scrollHeight;
  }

  function setProgress(v) {
    progressVal = Math.max(0, Math.min(100, v));
    progressBar.style.width = progressVal + '%';
    progressPct.textContent = Math.round(progressVal) + '%';
  }

  function stage(text, hint='') {
    progressStage.textContent = text;
    progressHint.textContent = hint || '请勿关闭此页面';
    logLine(text);
  }

  function startProgress() {
    progressWrap.style.display = 'block';
    loading.style.display = 'none';
    error.classList.add('d-none');
    success.classList.add('d-none');

    progressLogs.innerHTML = '';
    setProgress(2);
    stage('准备请求…');

    // 递增推进：先快后慢
    clearInterval(progressTimer);
    progressTimer = setInterval(() => {
      let inc = 0.6;
      if (progressVal > 60) inc = 0.3;
      if (progressVal > 80) inc = 0.15;
      if (progressVal > 90) inc = 0.08;
      if (progressVal >= progressCeil) return;
      setProgress(progressVal + inc);
    }, 1200);
  }

  function finishProgress(ok) {
    clearInterval(progressTimer);
    setProgress(ok ? 100 : progressVal);
    if (ok) {
      stage('完成 ✓', '正在渲染结果…');
      setTimeout(() => {
        progressWrap.style.display = 'none';
      }, 600);
    } else {
      // 失败保留进度区，交给 showError 隐藏
    }
  }

  cancelBtn.addEventListener('click', () => {
    if (controller) {
      controller.abort();
      stage('已取消请求');
      finishProgress(false);
      showError('已取消');
    }
  });

  // ———————————— 总览 & 课程分页（与你之前一致） ————————————

  function extractGpas(detail) {
    const stageResults = Array.isArray(detail?.stageResults) ? detail.stageResults : [];
    const stageGpas = [...new Set(stageResults.map(r => (r?.stageGpa || '').trim()).filter(Boolean))];
    const stageGpa = stageGpas.join(' / ') || '';
    const semesterGpa = (detail?.studentInfo?.semesterGpa || '').trim();
    return { stageGpa, semesterGpa };
  }

  function normalizeOverview(result) {
    if (Array.isArray(result?.all) && result.all.length > 0) {
      return result.all.map(x => {
        const s = x?.summary || {};
        const { stageGpa, semesterGpa } = extractGpas(x?.detail || {});
        return {
          term: s.term || '',
          stage: s.stage || '',
          year: s.year || '',
          programme: s.programme || '',
          major: s.major || '',
          results_url: s.results_url || s.resultsUrl || '#',
          stageGpa, semesterGpa
        };
      });
    }
    if (Array.isArray(result?.data)) {
      return result.data.map(s => ({
        term: s.term || '',
        stage: s.stage || '',
        year: s.year || '',
        programme: s.programme || '',
        major: s.major || '',
        results_url: s.results_url || s.resultsUrl || '#',
        stageGpa: '', semesterGpa: ''
      }));
    }
    return [];
  }

  function displayOverview(rows) {
    resultsBody.innerHTML = '';
    (rows || []).forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.term || ''}</td>
        <td>${item.stage || ''}</td>
        <td>${item.year || ''}</td>
        <td>${item.programme || ''}</td>
        <td>${item.major || ''}</td>
        <td class="nowrap">${item.stageGpa ? `<span class="badge bg-primary">${item.stageGpa}</span>` : ''}</td>
        <td class="nowrap">${item.semesterGpa ? `<span class="badge bg-secondary">${item.semesterGpa}</span>` : ''}</td>`;
      resultsBody.appendChild(tr);
    });
    rowsCount.textContent = `共 ${rows.length} 条`;
    resultsContainer.classList.remove('d-none');
  }

  let detailPages = [];
  let currentIndex = 0;

  function buildDetailPages(result) {
    detailPages = [];
    if (!Array.isArray(result?.all) || result.all.length === 0) return;

    result.all.forEach((entry, idx) => {
      const s = entry?.summary || {};
      const d = entry?.detail || {};
      const label = s.term || `学年 ${s.year || (idx + 1)}`;
      const { stageGpa, semesterGpa } = extractGpas(d);
      const rows = Array.isArray(d?.courseWork) ? d.courseWork.slice() : [];

      const weight = (sem) => (/autumn/i.test(sem) ? 0 : (/spring/i.test(sem) ? 1 : 2));
      rows.sort((a, b) => {
        const wa = weight(a?.semester || ''), wb = weight(b?.semester || '');
        if (wa !== wb) return wa - wb;
        return (a?.module || '').localeCompare(b?.module || '');
      });

      detailPages.push({ label, stageGpa, semesterGpa, rows });
    });
  }

  function renderDetailPage(index) {
    if (detailPages.length === 0) {
      detailContainer.classList.add('d-none');
      divider.classList.add('d-none');
      return;
    }

    currentIndex = Math.min(Math.max(index, 0), detailPages.length - 1);
    const page = detailPages[currentIndex];

    detailYearLabel.textContent = page.label;
    detailStageGpa.textContent = page.stageGpa || '—';
    detailSemesterGpa.textContent = page.semesterGpa || '—';

    detailBody.innerHTML = '';
    page.rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.semester || ''}</td>
        <td class="nowrap">${r.module || ''}</td>
        <td>${r.moduleTitle || ''}</td>
        <td class="nowrap">${r.stage || ''}</td>
        <td class="text-end">${r.credits || ''}</td>
        <td class="text-center">${r.grade || ''}</td>`;
      detailBody.appendChild(tr);
    });

    detailCount.textContent = `本学年共有 ${page.rows.length} 门课程`;
    pageIndicator.textContent = `${currentIndex + 1} / ${detailPages.length}`;

    yearSelect.value = String(currentIndex);
    prevYearBtn.disabled = currentIndex === 0;
    nextYearBtn.disabled = currentIndex === detailPages.length - 1;

    divider.classList.remove('d-none');
    detailContainer.classList.remove('d-none');
  }

  function initDetailPaginationUI() {
    yearSelect.innerHTML = '';
    detailPages.forEach((p, i) => {
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = p.label;
      yearSelect.appendChild(opt);
    });
    yearSelect.onchange = () => renderDetailPage(parseInt(yearSelect.value, 10) || 0);
    prevYearBtn.onclick = () => renderDetailPage(currentIndex - 1);
    nextYearBtn.onclick = () => renderDetailPage(currentIndex + 1);
  }

  // ———————————— 基础交互 ————————————
  function showError(message) {
    loading.style.display = 'none';
    progressWrap.style.display = 'none';
    errorMsg.textContent = message || '请求失败';
    error.classList.remove('d-none');
  }
  function showSuccess(message) {
    successMsg.textContent = message || '成功';
    success.classList.remove('d-none');
  }

  togglePwd.addEventListener('click', () => {
    const isPwd = passwordEl.type === 'password';
    passwordEl.type = isPwd ? 'text' : 'password';
    togglePwd.textContent = isPwd ? '隐藏' : '显示';
  });

  fetchBtn.addEventListener('click', async () => {
    const username = usernameEl.value.trim();
    const password = passwordEl.value.trim();
    if (!username || !password) {
      showError('请填写账号和密码');
      return;
    }

    // 启动拟真进度
    startProgress();
    stage('提交请求…');
    progressCeil = 30;

    // 可取消的 fetch
    controller = new AbortController();

    // 阶段性提示（前端推测，不影响真实逻辑）
    setTimeout(() => { stage('登录 UCD…'); progressCeil = Math.max(progressCeil, 55); }, 1200);
    setTimeout(() => { stage('进入 Registration & Results…'); progressCeil = Math.max(progressCeil, 70); }, 3500);
    setTimeout(() => { stage('解析汇总表…'); progressCeil = Math.max(progressCeil, 82); }, 5500);
    setTimeout(() => { stage('抓取各学年详情…'); progressCeil = Math.max(progressCeil, 95); }, 8000);

    try {
      const resp = await fetch('/api/ucd/results', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username, password }),
        signal: controller.signal
      });

      let result = null;
      try {
        result = await resp.json();
      } catch {
        finishProgress(false);
        showError('服务端返回的不是 JSON');
        return;
      }

      if (resp.ok && result?.success) {
        // 渲染结果
        const overviewRows = normalizeOverview(result);
        if (overviewRows.length === 0) {
          finishProgress(false);
          showError('没有可显示的成绩记录（后端返回为空或字段名不匹配）');
          return;
        }

        // 先把进度补满
        setProgress(98);
        stage('渲染页面…');
        // 渲染
        resultsBody.innerHTML = '';
        displayOverview(overviewRows);
        buildDetailPages(result);
        if (detailPages.length > 0) {
          initDetailPaginationUI();
          renderDetailPage(0);
        } else {
          divider.classList.add('d-none');
          detailContainer.classList.add('d-none');
        }
        finishProgress(true);
        showSuccess(result.message || `获取成功，共 ${overviewRows.length} 条`);
      } else {
        finishProgress(false);
        showError(result?.message || result?.error || '获取成绩数据失败');
      }
    } catch (err) {
      if (err?.name === 'AbortError') return; // 已在取消时处理
      finishProgress(false);
      showError('网络请求失败：' + (err?.message || err));
    } finally {
      controller = null;
    }
  });

  // 测试连接（GET）
  testBtn.addEventListener('click', async () => {
    testBtn.disabled = true;
    try {
      const resp = await fetch('/api/ucd/test');
      const result = await resp.json().catch(() => ({}));
      if (resp.ok && result?.success) {
        showSuccess('连接测试成功');
      } else {
        showError(result?.message || '连接测试失败');
      }
    } catch (err) {
      showError('连接测试失败：' + (err?.message || err));
    } finally {
      testBtn.disabled = false;
    }
  });
</script>
</body>
</html>
