{% extends "base.html" %}

{% block title %}首页 - BDIC-SE 知识库门户{% endblock %}

{% block content %}
<!-- Header Section -->
<section class="header-section">
    <div class="container">
        <div class="header-content text-center">
            <h1>
                <i class="fas fa-university me-3"></i>
                BDIC-SE 知识库门户
            </h1>
            <p class="lead">
                探索软件工程专业课程，了解教学内容，分享学习体验
            </p>
            
            <!-- Statistics Row -->
            <div class="row stats-row" id="statsContainer">
                <div class="col-md-3 col-6">
                    <div class="stat-item">
                        <span class="stat-number" id="totalCourses">-</span>
                        <div class="stat-label">门课程</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-item">
                        <span class="stat-number" id="totalInstructors">-</span>
                        <div class="stat-label">位讲师</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-item">
                        <span class="stat-number" id="totalReviews">-</span>
                        <div class="stat-label">条评价</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-item">
                        <span class="stat-number" id="avgRating">-</span>
                        <div class="stat-label">平均评分</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<div class="container">
    <!-- Stage Sections -->
    <div id="stageContainer">
        <!-- S1 Stage -->
        <div class="stage-container">
            <div class="stage-card">
                <div class="stage-header" onclick="toggleStage('S1')" tabindex="0" role="button" 
                     aria-expanded="false" aria-controls="stage-S1-content">
                    <h3 class="stage-title">
                        <i class="fas fa-seedling stage-icon"></i>
                        第一学期 (S1) - 基础入门
                    </h3>
                    <div class="stage-meta">
                        <span id="S1-count">- 门课程</span>
                    </div>
                    <i class="fas fa-chevron-down stage-toggle" id="toggle-S1"></i>
                </div>
                <div class="stage-content" id="stage-S1-content">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>加载课程中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- S2 Stage -->
        <div class="stage-container">
            <div class="stage-card">
                <div class="stage-header" onclick="toggleStage('S2')" tabindex="0" role="button" 
                     aria-expanded="false" aria-controls="stage-S2-content">
                    <h3 class="stage-title">
                        <i class="fas fa-layer-group stage-icon"></i>
                        第二学期 (S2) - 核心技术
                    </h3>
                    <div class="stage-meta">
                        <span id="S2-count">- 门课程</span>
                    </div>
                    <i class="fas fa-chevron-down stage-toggle" id="toggle-S2"></i>
                </div>
                <div class="stage-content" id="stage-S2-content">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>加载课程中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- S3 Stage -->
        <div class="stage-container">
            <div class="stage-card">
                <div class="stage-header" onclick="toggleStage('S3')" tabindex="0" role="button" 
                     aria-expanded="false" aria-controls="stage-S3-content">
                    <h3 class="stage-title">
                        <i class="fas fa-cogs stage-icon"></i>
                        第三学期 (S3) - 专业提升
                    </h3>
                    <div class="stage-meta">
                        <span id="S3-count">- 门课程</span>
                    </div>
                    <i class="fas fa-chevron-down stage-toggle" id="toggle-S3"></i>
                </div>
                <div class="stage-content" id="stage-S3-content">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>加载课程中...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- S4 Stage -->
        <div class="stage-container">
            <div class="stage-card">
                <div class="stage-header" onclick="toggleStage('S4')" tabindex="0" role="button" 
                     aria-expanded="false" aria-controls="stage-S4-content">
                    <h3 class="stage-title">
                        <i class="fas fa-graduation-cap stage-icon"></i>
                        第四学期 (S4) - 综合实践
                    </h3>
                    <div class="stage-meta">
                        <span id="S4-count">- 门课程</span>
                    </div>
                    <i class="fas fa-chevron-down stage-toggle" id="toggle-S4"></i>
                </div>
                <div class="stage-content" id="stage-S4-content">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>加载课程中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let stageData = {};
let expandedStages = new Set();

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadStageStats();
});

// Load overall statistics
async function loadStatistics() {
    try {
        const response = await fetch('/api/v1/courses/stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.data;
            document.getElementById('totalCourses').textContent = stats.total_courses || 0;
            
            // Load instructor count
            const instructorResponse = await fetch('/api/v1/instructors');
            const instructorData = await instructorResponse.json();
            if (instructorData.success) {
                document.getElementById('totalInstructors').textContent = instructorData.count || 0;
            }
            
            // Calculate total reviews and average rating
            let totalReviews = 0;
            let totalRating = 0;
            let ratedCourses = 0;
            
            const coursesResponse = await fetch('/api/v1/courses?per_page=100');
            const coursesData = await coursesResponse.json();
            
            if (coursesData.success) {
                coursesData.data.forEach(course => {
                    totalReviews += course.total_reviews || 0;
                    if (course.average_rating > 0) {
                        totalRating += course.average_rating;
                        ratedCourses++;
                    }
                });
                
                document.getElementById('totalReviews').textContent = totalReviews;
                document.getElementById('avgRating').textContent = 
                    ratedCourses > 0 ? (totalRating / ratedCourses).toFixed(1) : '0.0';
            }
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Load stage statistics
async function loadStageStats() {
    const stages = ['S1', 'S2', 'S3', 'S4'];
    
    for (const stage of stages) {
        try {
            const response = await fetch(`/api/v1/courses/by-stage/${stage}`);
            const data = await response.json();
            
            if (data.success) {
                const count = data.count || 0;
                document.getElementById(`${stage}-count`).textContent = `${count} 门课程`;
                stageData[stage] = data.data;
            }
        } catch (error) {
            console.error(`Error loading ${stage} stats:`, error);
            document.getElementById(`${stage}-count`).textContent = '- 门课程';
        }
    }
}

// Toggle stage expansion
function toggleStage(stage) {
    const content = document.getElementById(`stage-${stage}-content`);
    const toggle = document.getElementById(`toggle-${stage}`);
    const header = content.previousElementSibling;
    
    if (expandedStages.has(stage)) {
        // Collapse
        content.classList.remove('show');
        toggle.classList.remove('expanded');
        header.setAttribute('aria-expanded', 'false');
        expandedStages.delete(stage);
    } else {
        // Expand
        content.classList.add('show');
        toggle.classList.add('expanded');
        header.setAttribute('aria-expanded', 'true');
        expandedStages.add(stage);
        
        // Load courses if not already loaded
        if (!content.querySelector('.course-grid')) {
            loadStageCourses(stage);
        }
    }
}

// Load courses for a specific stage
async function loadStageCourses(stage) {
    const content = document.getElementById(`stage-${stage}-content`);
    
    try {
        if (stageData[stage] && stageData[stage].length > 0) {
            renderCourses(content, stageData[stage]);
        } else {
            content.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-book-open"></i>
                    <h4>暂无课程</h4>
                    <p>该学期暂时没有课程信息</p>
                </div>
            `;
        }
    } catch (error) {
        console.error(`Error loading ${stage} courses:`, error);
        content.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>加载失败</h4>
                <p>无法加载课程信息，请稍后重试</p>
            </div>
        `;
    }
}

// Render courses in grid
function renderCourses(container, courses) {
    const grid = document.createElement('div');
    grid.className = 'course-grid';
    
    courses.forEach(course => {
        const courseCard = createCourseCard(course);
        grid.appendChild(courseCard);
    });
    
    container.innerHTML = '';
    container.appendChild(grid);
}

// Create individual course card
function createCourseCard(course) {
    const card = document.createElement('div');
    card.className = 'course-card';
    
    const stars = generateStars(course.average_rating);
    const description = course.description ? 
        (course.description.length > 120 ? course.description.substring(0, 120) + '...' : course.description) : 
        '暂无课程描述';
    
    card.innerHTML = `
        <div class="course-title">
            <a href="/courses/${course.id}">${escapeHtml(course.title)}</a>
        </div>
        <div class="course-instructor">
            <i class="fas fa-user-tie"></i>
            ${escapeHtml(course.instructor ? course.instructor.name : '未知讲师')}
        </div>
        <div class="course-description">
            ${escapeHtml(description)}
        </div>
        <div class="course-footer">
            <div class="course-rating">
                <span class="stars">${stars}</span>
                <span>${course.average_rating.toFixed(1)}</span>
            </div>
            <div class="course-reviews">
                ${course.total_reviews} 条评价
            </div>
        </div>
    `;
    
    return card;
}

// Generate star rating HTML
function generateStars(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    
    let stars = '';
    
    // Full stars
    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star"></i>';
    }
    
    // Half star
    if (hasHalfStar) {
        stars += '<i class="fas fa-star-half-alt"></i>';
    }
    
    // Empty stars
    for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star"></i>';
    }
    
    return stars;
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Keyboard navigation support
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
        const target = e.target;
        if (target.classList.contains('stage-header')) {
            e.preventDefault();
            target.click();
        }
    }
});
</script>
{% endblock %}
